# Installing in Docker

## Installation

This guide will show you how to get akkoma working in a docker container,
if you want isolation, or if you run a distribution not supported by the OTP
releases.

If you want to migrate from or OTP to docker, check out [the migration guide](./migrating_to_docker_en.md).

### Prepare the system

* Install docker and docker compose
  * [Docker](https://docs.docker.com/engine/install/) 
  * [Docker-compose](https://docs.docker.com/compose/install/)
  * This will usually just be a repository installation and a package manager invocation.
* Clone the akkoma repository
  * `git clone https://akkoma.dev/AkkomaGang/akkoma.git -b stable`
  * `cd akkoma`

### Set up basic configuration

```bash
cp docker-resources/env.example .env
echo "DOCKER_USER=$(id -u):$(id -g)" >> .env
```

This probably won't need to be changed, it's only there to set basic environment
variables for the docker compose file.

### Generating your instance

```bash
mkdir pgdata
./docker-resources/generate-instance.sh
```

This will ask you a few questions - the defaults are fine for most things!

Now we'll want to copy over the config it just created

```bash
cp config/generated_config.exs config/prod.secret.exs
```

### Start the server

We're going to run it in the foreground on the first run, just to make sure
everything start up.

```bash
docker compose up
```

If everything went well, you should be able to access your instance at http://localhost:4000

You can `ctrl-c` out of the docker compose now to shutdown the server.

### Running in the background

```bash
docker compose up -d
```

### Create your first user

If your instance is up and running, you can create your first user with administrative rights with the following task:

```shell
./docker-resources/manage.sh user new MY_USERNAME MY_EMAIL@SOMEWHERE --admin
```

And follow the prompts 

### Reverse proxies

This is a tad more complex in docker than on the host itself. It

You've got two options. 

#### Running caddy in a container

This is by far the easiest option. It'll handle HTTPS and all that for you. 

```bash
mkdir caddy-data
mkdir caddy-config
cp docker-resources/Caddyfile.example docker-resources/Caddyfile
```

Then edit the TLD in your caddyfile to the domain you're serving on.

Copy the commented out `caddy` section in `docker-compose.yml` into a new file called `docker-compose.override.yml` like so:
```yaml
version: "3.7"

services:
  proxy:
    image: caddy:2-alpine
    restart: unless-stopped
    links:
      - akkoma
    ports: [
       "443:443",
       "80:80"
    ]
    volumes:
      - ./docker-resources/Caddyfile:/etc/caddy/Caddyfile
      - ./caddy-data:/data
      - ./caddy-config:/config
```

then run `docker compose up -d` again.

#### Running a reverse proxy on the host

If you want, you can also run the reverse proxy on the host. This is a bit more complex, but it's also more flexible.

Follow the guides for source install for your distribution of choice, or adapt
as needed. Your standard setup can be found in the [Debian Guide](../debian_based_en/#nginx)

### Applying Postgresql optimisations

Your postgresql server will behave better if you tune its settings to your machine.

There is a file at `docker-resources/docker-compose.pgsql-tuning.yml` which shows you how to apply settings, for example
those generated by [PgTune](https://pgtune.leopard.in.ua/)

You can merge this config into a `docker-compose.override.yml` file to apply them. Make sure that you generate your options
based on the shm_size you allocate!

### You're done!

All that's left is to set up your frontends. 

The standard OTP commands will apply to you, just make sure you
prefix them with `./docker-resources/manage.sh`!

So, for example, if an OTP command would be

```
./bin/pleroma_ctl user new myuser
```

The equivalent docker command would be

```
./docker-resources/manage.sh user new myuser
```

{! installation/frontends.include !}

### Updating Docker Installs

```bash
git pull
docker compose pull
./docker-resources/manage.sh migrate
docker compose restart akkoma db
```

### Modifying the Docker services
If you want to modify the services defined in the docker compose file, you can
create a new file called `docker-compose.override.yml`. There you can add any
overrides or additional services without worrying about git conflicts when a
new release comes out.

### Migrating from the old docker install system

If you were running akkoma in docker before 2024.06, you will need to do a few little migration steps.

First off, we need to migrate our postgres installation to a newer version!

```bash
./docker-resources/migrate-postgresql-version.sh pgdata 14 16    
```

This should be nice and quick.

After that you can just `docker compose pull` and all should be fine.

#### Further reading

{! installation/further_reading.include !}

{! support.include !}
